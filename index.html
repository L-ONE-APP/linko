<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KUZBOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-header: rgba(0, 0, 0, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #8B5CF6;
            --accent-light: #A78BFA;
            --border-color: #333333;
            --shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        html[data-theme='light'] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --bg-header: rgba(249, 250, 251, 0.7);
            --text-primary: #000000;
            --text-secondary: #505050;
            --accent: #7C3AED;
            --accent-light: #8B5CF6;
            --border-color: #e5e7eb;
            --shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Общие стили */
        .glass-header { position: sticky; top: 0; z-index: 10; background-color: var(--bg-header); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); padding-top: calc(var(--safe-area-top) + 1rem); border-bottom: 1px solid var(--border-color); }
        .glass-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; background-color: var(--bg-header); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); padding-bottom: var(--safe-area-bottom); border-top: 1px solid var(--border-color); }
        main { padding-bottom: calc(var(--safe-area-bottom) + 70px); }
        .accent-button { background-color: var(--accent); color: white; box-shadow: var(--shadow); transition: all 0.2s ease-in-out; }
        .accent-button:hover:not(:disabled) { transform: scale(1.02); filter: brightness(1.1); }
        .accent-button:disabled { background-color: var(--text-secondary); opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .no-outline:focus { outline: none; box-shadow: none; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Стили модальных окон */
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; transform: translateY(100%); opacity: 0; pointer-events: none; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        /* Анимации */
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* Чекбокс и скроллер дат */
        .checkbox-custom { -webkit-appearance: none; appearance: none; background-color: transparent; width: 1.5rem; height: 1.5rem; border: 2px solid var(--text-secondary); border-radius: 0.375rem; display: inline-block; position: relative; cursor: pointer; transition: all 0.2s ease; }
        .checkbox-custom:checked { background-color: var(--accent); border-color: var(--accent); }
        .checkbox-custom:checked::after { content: ''; position: absolute; left: 0.45rem; top: 0.15rem; width: 0.4rem; height: 0.8rem; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .date-scroller-btn { position: relative; transition: color 0.3s ease; }
        .date-scroller-btn.active::after { content: ''; position: absolute; bottom: -8px; left: 25%; right: 25%; height: 3px; background-color: var(--accent); border-radius: 2px; animation: underlineGrow 0.3s ease; }
        @keyframes underlineGrow { from { width: 0; left: 50%; } to { width: 50%; left: 25%; } }

        /* Стили экранов */
        .screen { position: absolute; top: 0; left: 0; right: 0; height: 100%; transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.left { transform: translateX(-100%); }
        .screen.right { transform: translateX(100%); }
        .screen.center { transform: translateX(0); }
        
        /* Стили админ-панели и инпутов */
        .admin-input, .admin-textarea { background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; transition: border-color 0.2s; }
        .admin-input:focus, .admin-textarea:focus { outline: none; border-color: var(--accent); }
        .file-input-label { display: block; padding: 0.75rem 1rem; background-color: var(--bg-tertiary); border-radius: 0.75rem; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .file-input-label:hover { background-color: var(--border-color); }
        #admin-status { position: fixed; bottom: calc(var(--safe-area-bottom) + 65px); left: 1rem; right: 1rem; z-index: 30; pointer-events: none; }

        /* НОВЫЙ ЭКРАН ВХОДА */
        #onboarding-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            filter: blur(40px);
            opacity: 0.6;
        }
        .onboarding-input {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .onboarding-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Спиннер загрузки */
        .loader { width: 48px; height: 48px; border: 5px solid var(--text-primary); border-bottom-color: var(--accent); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loader-container { position: absolute; inset: 0; z-index: 99; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="relative h-screen w-screen overflow-hidden">
        <!-- Onboarding Screen -->
        <div id="screen-onboarding" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-hidden" style="background-color: #000000;">
            <canvas id="onboarding-canvas"></canvas>
            <div class="z-10 w-full max-w-sm">
                <div id="onboarding-step-1">
                    <div class="fade-in-up">
                        <h1 class="text-6xl font-extrabold tracking-tighter text-white">KUZBOOK</h1>
                        <p class="mt-2 text-lg text-gray-200">Твой удобный дневник</p>
                    </div>
                    <button id="btn-welcome-continue" class="accent-button w-full mt-20 py-4 text-lg font-semibold rounded-xl no-outline fade-in-up" style="animation-delay: 0.2s;">Продолжить</button>
                </div>
                <div id="onboarding-step-2" class="hidden">
                    <h2 class="text-3xl font-bold text-white fade-in-up">Как тебя зовут?</h2>
                    <p class="mt-2 text-gray-200 fade-in-up" style="animation-delay: 0.1s;">Используй свои настоящие имя и фамилию.</p>
                    <input id="input-firstname" type="text" placeholder="Имя" class="onboarding-input w-full mt-8 p-4 text-lg rounded-xl no-outline fade-in-up" style="animation-delay: 0.2s;">
                    <input id="input-lastname" type="text" placeholder="Фамилия" class="onboarding-input w-full mt-4 p-4 text-lg rounded-xl no-outline fade-in-up" style="animation-delay: 0.3s;">
                    <button id="btn-name-continue" class="accent-button w-full mt-8 py-4 text-lg font-semibold rounded-xl no-outline fade-in-up" style="animation-delay: 0.4s;">Продолжить</button>
                </div>
                <!-- Другие шаги онбординга... -->
                 <div id="onboarding-step-3" class="hidden w-full max-w-sm">
                    <h2 class="text-3xl font-bold text-white fade-in-up">Всё верно?</h2>
                    <p id="confirm-name" class="mt-4 text-2xl font-semibold fade-in-up" style="animation-delay: 0.1s; color: var(--accent-light);"></p>
                    <div class="flex gap-4 mt-8 fade-in-up" style="animation-delay: 0.2s;">
                        <button id="btn-name-back" class="w-full py-4 text-lg font-semibold rounded-xl no-outline onboarding-input">Назад</button>
                        <button id="btn-name-confirm" class="accent-button w-full py-4 text-lg font-semibold rounded-xl no-outline">Да, всё так</button>
                    </div>
                </div>
                <div id="onboarding-step-4" class="hidden w-full max-w-sm">
                    <h2 class="text-3xl font-bold text-white fade-in-up">Выбери тему</h2>
                    <p class="mt-2 text-gray-200 fade-in-up" style="animation-delay: 0.1s;">Её можно будет изменить в настройках.</p>
                    <div class="flex gap-4 mt-8 fade-in-up" style="animation-delay: 0.2s;">
                        <button data-theme="light" class="theme-btn w-full py-10 text-lg font-semibold rounded-xl border-2 no-outline transition-transform hover:scale-105" style="background-color: #ffffff; color: #000000; border-color: var(--accent);">Светлая</button>
                        <button data-theme="dark" class="theme-btn w-full py-10 text-lg font-semibold rounded-xl border-2 no-outline transition-transform hover:scale-105" style="background-color: #111111; color: #ffffff; border-color: var(--accent);">Тёмная</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="content-wrapper" class="opacity-0 transition-opacity duration-500 w-full h-full">
            <div id="loader-container" class="opacity-0 pointer-events-none"><div class="loader"></div></div>
            <!-- Main App Screen -->
            <div id="screen-main" class="screen center flex-col overflow-y-auto">
                <header class="glass-header p-4 flex-shrink-0">
                    <h1 class="text-4xl font-bold tracking-tight">Расписание</h1>
                    <div id="date-scroller" class="horizontal-scroll flex items-center gap-2 mt-4 overflow-x-auto pb-4"></div>
                </header>
                <main id="homework-list" class="flex-grow p-4"></main>
            </div>

            <!-- Profile Screen -->
            <div id="screen-profile" class="screen right flex-col overflow-y-auto">
                 <header class="glass-header p-4 flex-shrink-0 flex items-center justify-between">
                    <h1 class="text-4xl font-bold tracking-tight">Профиль</h1>
                     <button id="btn-logout" class="p-2 rounded-lg" style="background-color: var(--bg-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </header>
                <main class="flex-grow p-4">
                    <div class="flex items-center gap-4 p-4 rounded-2xl" style="background-color: var(--bg-secondary);">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: var(--bg-primary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div>
                        <div><h2 id="profile-name" class="text-2xl font-bold"></h2><p style="color: var(--text-secondary);">Ученик</p></div>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-2xl font-bold mb-2">Оценки</h3>
                        <div id="grades-quarters" class="flex gap-2 mb-4 border-b" style="border-color: var(--bg-secondary);">
                            <button class="quarter-btn p-3 font-semibold border-b-2" data-quarter="1">1-я</button><button class="quarter-btn p-3 font-semibold" data-quarter="2">2-я</button><button class="quarter-btn p-3 font-semibold" data-quarter="3">3-я</button><button class="quarter-btn p-3 font-semibold" data-quarter="4">4-я</button>
                        </div>
                        <div id="grades-list" class="space-y-4"></div>
                    </div>
                </main>
            </div>

            <!-- Admin Screen -->
            <div id="screen-admin" class="screen right flex-col overflow-y-auto">
                <header class="glass-header p-4 flex-shrink-0">
                    <h1 class="text-4xl font-bold tracking-tight">Админ-панель</h1>
                </header>
                <main class="flex-grow p-4 space-y-6">
                    <button id="admin-fill-hw" class="w-full p-6 rounded-2xl text-left flex items-center justify-between" style="background-color: var(--bg-secondary);">
                        <div>
                            <h2 class="text-xl font-bold">Заполнить ДЗ</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Автоматически с помощью AI</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                     <button id="admin-fill-grades" class="w-full p-6 rounded-2xl text-left flex items-center justify-between" style="background-color: var(--bg-secondary);">
                        <div>
                            <h2 class="text-xl font-bold">Заполнить Оценки</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Распознать из фото журнала</p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </main>
            </div>
            
            <nav id="app-nav" class="glass-nav flex justify-around items-center h-[55px]"></nav>
        </div>

        <div id="admin-status" class="text-center p-4 rounded-lg opacity-0 transition-opacity duration-300"></div>

        <!-- Modals -->
        <div id="modal-overlay" class="modal-overlay fixed inset-0 z-20"></div>
        <div id="modal-lesson" class="modal fixed inset-0 z-30 flex flex-col p-4" style="background-color: var(--bg-primary); padding-top: calc(var(--safe-area-top) + 1rem);"></div>
        <div id="modal-ai-solution" class="modal fixed inset-0 z-50 flex flex-col p-4" style="background-color: var(--bg-primary); padding-top: calc(var(--safe-area-top) + 1rem);"></div>
        <div id="modal-grades" class="modal fixed inset-0 z-30 flex flex-col p-4" style="background-color: var(--bg-primary); padding-top: calc(var(--safe-area-top) + 1rem);"></div>
        <div id="modal-admin-flow" class="modal fixed inset-0 z-40 flex flex-col p-4" style="background-color: var(--bg-primary); padding-top: calc(var(--safe-area-top) + 1rem);"></div>

    </div>
    <script>
        const SUPABASE_URL = 'https://biooiajgiryjxkeqtakg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb29pYWpnaXJ5anhrZXF0YWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Njk2NDMsImV4cCI6MjA3NTQ0NTY0M30._DmT77M0LcRLHQDRdKZmspOsxuXIByGuiBDndfIMK1Y';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const TG = window.Telegram.WebApp;

        // --- DOM ELEMENTS & STATE ---
        const mainScreen = document.getElementById('screen-main');
        const profileScreen = document.getElementById('screen-profile');
        const adminScreen = document.getElementById('screen-admin');
        const onboardingScreen = document.getElementById('screen-onboarding');
        const appNav = document.getElementById('app-nav');
        const loader = document.getElementById('loader-container');
        const modals = { 
            overlay: document.getElementById('modal-overlay'), 
            lesson: document.getElementById('modal-lesson'), 
            solution: document.getElementById('modal-ai-solution'), 
            grades: document.getElementById('modal-grades'),
            admin: document.getElementById('modal-admin-flow')
        };
        
        let state = { user: null, currentScreen: 'main', screens: ['main', 'profile'], adminFlowData: {} };
        let currentOpenModal = null; 
        let currentLessonCache = null;

        // --- UTILS ---
        const vibrate = () => { if (TG.HapticFeedback) TG.HapticFeedback.impactOccurred('light'); };
        const showLoader = () => { loader.classList.remove('opacity-0', 'pointer-events-none'); };
        const hideLoader = () => { loader.classList.add('opacity-0', 'pointer-events-none'); };
        const fileToPart = file => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve({ inlineData: { mimeType: file.type, data: reader.result.split(',')[1] } });
            reader.readAsDataURL(file);
        });

        // --- ONBOARDING & APP INIT ---
        function initOnboardingAnimation() {
            const canvas = document.getElementById('onboarding-canvas');
            const ctx = canvas.getContext('2d');
            let circles = [];

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            class Circle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.radius = Math.random() * 150 + 50;
                    this.vx = Math.random() * 0.4 - 0.2;
                    this.vy = Math.random() * 0.4 - 0.2;
                    this.color = `rgba(${Math.random() * 50}, ${Math.random() * 100 + 100}, 255, ${Math.random() * 0.5 + 0.1})`;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                circles.forEach(circle => {
                    circle.update();
                    circle.draw();
                });
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            for (let i = 0; i < 5; i++) {
                circles.push(new Circle());
            }
            animate();
        }

        const onboardingSteps = { '1': document.getElementById('onboarding-step-1'),'2': document.getElementById('onboarding-step-2'),'3': document.getElementById('onboarding-step-3'),'4': document.getElementById('onboarding-step-4') };
        function switchOnboardingStep(from, to) { 
            const fromEl = onboardingSteps[from];
            const toEl = onboardingSteps[to];
            fromEl.classList.add('hidden');
            toEl.classList.remove('hidden');
            // Re-trigger animations
            toEl.querySelectorAll('.fade-in-up').forEach(el => {
                el.classList.remove('fade-in-up');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('fade-in-up');
            });
        }
        document.getElementById('btn-welcome-continue').addEventListener('click', () => { vibrate(); switchOnboardingStep('1', '2'); });
        document.getElementById('btn-name-continue').addEventListener('click', () => { if (document.getElementById('input-firstname').value.trim() && document.getElementById('input-lastname').value.trim()) { vibrate(); document.getElementById('confirm-name').textContent = `${document.getElementById('input-firstname').value.trim()} ${document.getElementById('input-lastname').value.trim()}`; switchOnboardingStep('2', '3'); } });
        document.getElementById('btn-name-back').addEventListener('click', () => switchOnboardingStep('3', '2'));
        document.getElementById('btn-name-confirm').addEventListener('click', () => { vibrate(); switchOnboardingStep('3', '4'); });
        document.querySelectorAll('.theme-btn').forEach(btn => btn.addEventListener('click', async (e) => { vibrate(); finishOnboarding(e.currentTarget.dataset.theme); }));
        async function finishOnboarding(theme) {
            showLoader();
            let firstname = document.getElementById('input-firstname').value.trim(); let lastname = document.getElementById('input-lastname').value.trim(); let fullName = `${lastname} ${firstname}`, shortName = `${lastname} ${firstname.charAt(0)}.`, isAdmin = false; if (firstname.toUpperCase() === 'KUZBOOK' && lastname.toUpperCase() === 'ADMIN') { fullName = 'Бутенко Всеволод'; shortName = 'Бутенко В.'; isAdmin = true; }
            let { data: existingUser } = await db.from('users').select('*').eq('full_name', fullName).single();
            if (existingUser) { state.user = existingUser; if (existingUser.theme !== theme) { await db.from('users').update({ theme: theme }).eq('id', existingUser.id); state.user.theme = theme; } } else { const { data: newUser, error } = await db.from('users').insert({ full_name: fullName, short_name: shortName, is_admin: isAdmin, theme: theme }).select().single(); if (error) { console.error("Profile creation error:", error); hideLoader(); return; } state.user = newUser; }
            localStorage.setItem('kuzbook_user', JSON.stringify(state.user));
            setTheme(state.user.theme || 'dark');
            onboardingScreen.classList.add('opacity-0');
            setTimeout(() => { onboardingScreen.style.display = 'none'; startApp(); hideLoader(); }, 500);
        }

        // --- APP INITIALIZATION & CORE ---
        function init() {
            TG.ready(); TG.expand();
            const savedUser = localStorage.getItem('kuzbook_user');
            if (savedUser) { state.user = JSON.parse(savedUser); onboardingScreen.style.display = 'none'; setTheme(state.user.theme || 'dark'); startApp(); } else { onboardingScreen.style.display = 'flex'; setTheme(TG.colorScheme || 'dark'); initOnboardingAnimation(); }
            TG.onEvent('themeChanged', () => { if(!state.user?.theme) setTheme(TG.colorScheme); });
        }
        
        function startApp() { if (state.user.is_admin) state.screens.push('admin'); document.getElementById('content-wrapper').classList.add('opacity-100'); renderNav(); setupDateScroller(); renderHomeworkForDate(new Date()); renderProfile(); if(state.user.is_admin) setupAdminPanel(); }
        function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); }
        document.getElementById('btn-logout').addEventListener('click', () => { vibrate(); localStorage.removeItem('kuzbook_user'); window.location.reload(); });

        // --- NAVIGATION & UI ---
        function renderNav() {
            let navHTML = `<button data-screen="main" class="nav-btn p-2 rounded-lg w-20 text-center transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg><span class="text-xs font-medium">ДЗ</span></button><button data-screen="profile" class="nav-btn p-2 rounded-lg w-20 text-center transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" /></svg><span class="text-xs font-medium">Профиль</span></button>`;
            if (state.user?.is_admin) { navHTML += `<button data-screen="admin" class="nav-btn p-2 rounded-lg w-20 text-center transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.96.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734-2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg><span class="text-xs font-medium">Админ</span></button>`; }
            appNav.innerHTML = navHTML;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', navigate));
            updateNavButtons();
        }

        function navigate() { vibrate(); const newScreen = this.dataset.screen; if (newScreen === state.currentScreen) return; const oldScreenEl = document.getElementById(`screen-${state.currentScreen}`); const newScreenEl = document.getElementById(`screen-${newScreen}`); const oldIndex = state.screens.indexOf(state.currentScreen); const newIndex = state.screens.indexOf(newScreen); if (newIndex > oldIndex) { oldScreenEl.classList.remove('center'); oldScreenEl.classList.add('left'); newScreenEl.classList.remove('right'); newScreenEl.classList.add('center'); } else { oldScreenEl.classList.remove('center'); oldScreenEl.classList.add('right'); newScreenEl.classList.remove('left'); newScreenEl.classList.add('center'); } state.currentScreen = newScreen; updateNavButtons(); }
        function updateNavButtons() { document.querySelectorAll('.nav-btn').forEach(btn => { btn.style.color = btn.dataset.screen === state.currentScreen ? 'var(--accent)' : 'var(--text-secondary)'; }); }
        
        // --- HOMEWORK SCREEN ---
        function setupDateScroller() { const scroller = document.getElementById('date-scroller'), today = new Date(), days = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ']; scroller.innerHTML = ''; for (let i = -10; i <= 10; i++) { const date = new Date(); date.setDate(today.getDate() + i); const isToday = i === 0; const dateEl = document.createElement('button'); dateEl.className = `date-scroller-btn flex-shrink-0 flex flex-col items-center justify-center w-12 h-16 no-outline ${isToday ? 'active' : ''}`; dateEl.style.color = isToday ? 'var(--accent)' : 'var(--text-secondary)'; dateEl.dataset.date = date.toISOString().split('T')[0]; dateEl.innerHTML = `<span class="text-sm font-semibold">${days[date.getDay()]}</span><span class="text-xl font-bold">${date.getDate()}</span>`; dateEl.addEventListener('click', (e) => { vibrate(); const currentActive = scroller.querySelector('.active'); if (currentActive) { currentActive.classList.remove('active'); currentActive.style.color = 'var(--text-secondary)'; } e.currentTarget.classList.add('active'); e.currentTarget.style.color = 'var(--accent)'; renderHomeworkForDate(date); }); scroller.appendChild(dateEl); if (isToday) setTimeout(() => dateEl.scrollIntoView({ behavior: 'smooth', inline: 'center' }), 100); } }
        
        async function renderHomeworkForDate(date) {
            const list = document.getElementById('homework-list');
            list.innerHTML = `<div class="flex justify-center mt-10"><div class="loader"></div></div>`;
            const dateString = date.toISOString().split('T')[0];
            const { data: schedule, error } = await db.from('schedule').select(`*, attachments(*)`).eq('lesson_date', dateString);
            if (error || !schedule || schedule.length === 0) { list.innerHTML = `<div class="text-center mt-10 opacity-50"><img src="notData.png" class="mx-auto w-32 h-32"><p class="mt-4" style="color: var(--text-secondary);">Еще нет данных</p></div>`; return; }
            const scheduleIds = schedule.map(s => s.id);
            const { data: statuses } = await db.from('homework_status').select('schedule_id').eq('user_id', state.user.id).in('schedule_id', scheduleIds);
            const completedIds = new Set(statuses ? statuses.map(s => s.schedule_id) : []);
            list.innerHTML = '';
            schedule.forEach(hw => {
                const hasHw = hw.homework_text && hw.homework_text.trim() !== '';
                const isCompleted = completedIds.has(hw.id);
                const item = document.createElement('div');
                item.className = 'flex items-center gap-4 p-4 rounded-2xl mb-3 fade-in'; item.style.backgroundColor = 'var(--bg-secondary)';
                item.innerHTML = `<div class="flex-grow"><p class="font-bold text-lg">${hw.subject}</p><p class="text-sm" style="color: var(--text-secondary);">${hw.time}</p></div>${hasHw ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" style="color: var(--accent);" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>` : '<div class="w-6"></div>'}<input type="checkbox" data-schedule-id="${hw.id}" class="checkbox-custom flex-shrink-0" ${isCompleted ? 'checked' : ''}>`;
                if (hasHw) { item.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') openModal(modals.lesson, hw); }); }
                item.querySelector('input[type="checkbox"]').addEventListener('change', handleCheckboxChange);
                list.appendChild(item);
            });
        }
        
        async function handleCheckboxChange(e) { vibrate(); const scheduleId = parseInt(e.target.dataset.scheduleId, 10); if (e.target.checked) { await db.from('homework_status').upsert({ user_id: state.user.id, schedule_id: scheduleId }); } else { await db.from('homework_status').delete().match({ user_id: state.user.id, schedule_id: scheduleId }); } }
        
        // --- PROFILE SCREEN ---
        function renderProfile() { if (!state.user) return; document.getElementById('profile-name').textContent = state.user.short_name; const quarterButtons = document.querySelectorAll('.quarter-btn'); quarterButtons.forEach(btn => btn.addEventListener('click', handleQuarterClick)); handleQuarterClick({ target: quarterButtons[0] }); }
        function handleQuarterClick(e) { vibrate(); document.querySelector('.quarter-btn[style*="var(--accent)"]')?.setAttribute('style', 'color: var(--text-secondary); border-color: transparent;'); e.target.setAttribute('style', 'color: var(--accent); border-color: var(--accent);'); renderGradesForQuarter(parseInt(e.target.dataset.quarter)); }
        async function renderGradesForQuarter(quarter) {
            const list = document.getElementById('grades-list');
            list.innerHTML = `<div class="flex justify-center mt-10"><div class="loader"></div></div>`;
            const { data: gradesData, error } = await db.from('grades').select('*').eq('user_id', state.user.id).eq('quarter', quarter);
            if (error || !gradesData || gradesData.length === 0) { list.innerHTML = `<div class="text-center mt-10 opacity-50"><img src="notData.png" class="mx-auto w-32 h-32"><p class="mt-4" style="color: var(--text-secondary);">Оценок за эту четверть пока нет.</p></div>`; return; }
            list.innerHTML = '';
            gradesData.forEach(subjectGrades => {
                const item = document.createElement('div');
                item.className = 'p-4 rounded-2xl fade-in';
                item.style.backgroundColor = 'var(--bg-secondary)';
                item.innerHTML = `<h3 class="font-bold text-lg mb-2">${subjectGrades.subject}</h3><div class="flex flex-wrap gap-2">${subjectGrades.grades_data.map(g => `<div class="w-10 h-10 flex items-center justify-center rounded-lg font-bold text-md ${getGradeColor(g)}">${g}</div>`).join('')}</div>`;
                list.appendChild(item);
            });
        }
        const getGradeColor = (g) => ({ '5': 'bg-green-500 text-white', '4': 'bg-yellow-500 text-white', '3': 'bg-orange-500 text-white', '2': 'bg-red-500 text-white', 'Б': 'bg-blue-500 text-white', 'Н': 'bg-gray-500 text-white', 'ОП': 'bg-purple-500 text-white', 'ТЧК': 'bg-pink-500 text-white' }[g] || 'bg-gray-700 text-white');
        

        // --- ADMIN PANEL LOGIC ---
        function setupAdminPanel() {
            document.getElementById('admin-fill-hw').addEventListener('click', () => { vibrate(); openAdminHwFlow(); });
            document.getElementById('admin-fill-grades').addEventListener('click', () => { vibrate(); openAdminGradesFlow(); });
        }
        function showAdminStatus(message, isError) { const statusEl = document.getElementById('admin-status'); statusEl.textContent = message; statusEl.className = `text-center p-4 rounded-lg opacity-100 transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`; setTimeout(() => { statusEl.classList.remove('opacity-100'); }, 4000); }

        // --- MODAL LOGIC ---
        function openModal(modal, data) { modals.overlay.classList.add('active'); currentOpenModal = modal; populateModal(modal, data); modal.classList.add('active'); TG.BackButton.show(); }
        function closeModal() { if (currentOpenModal) { modals.overlay.classList.remove('active'); currentOpenModal.classList.remove('active'); currentOpenModal = null; } TG.BackButton.hide(); }
        
        // --- AI API CALL ---
        async function callGemini(prompt, imageParts = []) {
            const apiKey = "AIzaSyCglJfoIkzBHeJ3uq4b6afqYs3g6niKgd0"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }, ...imageParts] }] };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errorBody = await response.json(); console.error("API Error Body:", errorBody); throw new Error(`API Error: ${response.statusText}`); }
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("Не удалось получить ответ от AI.");
            return text;
        }

        // --- POPULATE MODALS ---
        async function populateModal(modal, data) {
            modal.innerHTML = '';
            switch(modal) {
                case modals.lesson:
                    currentLessonCache = data;
                    const hwFiles = data.attachments.filter(a => a.attachment_type === 'homework').map(file => `<a href="${db.storage.from('kuzbook_files').getPublicUrl(file.file_path).data.publicUrl}" target="_blank" class="flex items-center gap-3 p-3 rounded-lg no-underline" style="background-color: var(--bg-primary); color: var(--text-primary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg><span class="truncate">${file.file_name}</span></a>`).join('');
                    modal.innerHTML = `<header class="flex-shrink-0 flex items-center justify-between pb-4"><div><h2 class="text-3xl font-bold">${data.subject}</h2><p class="text-sm" style="color: var(--text-secondary);">${data.time}</p></div><button class="modal-close-btn p-2 rounded-full" style="background-color: var(--bg-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></header><main class="flex-grow overflow-y-auto"><h3 class="font-semibold text-lg mb-2">Домашнее задание:</h3><p class="whitespace-pre-wrap">${data.homework_text || 'Нет.'}</p><div class="mt-4 space-y-2">${hwFiles}</div></main><footer class="flex-shrink-0 pt-4"><button id="btn-ai-solve" class="accent-button w-full py-4 text-lg font-semibold rounded-xl no-outline">Решить с AI</button></footer>`;
                    modal.querySelector('#btn-ai-solve').addEventListener('click', () => { vibrate(); openAiSolution(data); });
                    break;
                case modals.solution:
                    modal.innerHTML = `<header class="flex-shrink-0 flex items-center justify-between pb-4"><h2 class="text-3xl font-bold">Решение от AI</h2><button class="modal-close-btn p-2 rounded-full" style="background-color: var(--bg-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></header><main class="flex-grow overflow-y-auto" id="ai-solution-content"><div class="flex justify-center mt-10"><div class="loader"></div></div></main>`;
                    try {
                        let prompt = `Подробно реши следующее домашнее задание по предмету "${data.subject}":\n\n${data.homework_text}`;
                        // TODO: Add image analysis for homework attachments if needed
                        const solution = await callGemini(prompt);
                        document.getElementById('ai-solution-content').innerHTML = `<p class="whitespace-pre-wrap">${solution}</p>`;
                    } catch (e) { document.getElementById('ai-solution-content').innerHTML = `<p>Ошибка при получении решения: ${e.message}</p>`; }
                    break;
            }
            modal.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
        }

        function openAiSolution(lessonData) {
            closeModal();
            openModal(modals.solution, lessonData);
        }

        // --- NEW ADMIN FLOWS ---
        function openAdminHwFlow() { /* To be implemented */ alert("Функция заполнения ДЗ в разработке!"); }
        async function openAdminGradesFlow() { 
            state.adminFlowData = {}; // Reset
            openModal(modals.admin); 
            renderAdminGradesStep(1);
        }

        function renderAdminGradesStep(step) {
            const modal = modals.admin;
            let content = '';
            switch(step) {
                case 1: // Upload photo
                    content = `
                        <header class="flex-shrink-0 flex items-center justify-between pb-4"><h2 class="text-2xl font-bold">Шаг 1: Загрузка фото</h2><button class="modal-close-btn p-2 rounded-full" style="background-color: var(--bg-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></header>
                        <main class="flex-grow flex flex-col justify-center items-center text-center">
                            <p class="mb-4">Прикрепите фото страницы журнала с оценками.</p>
                            <label for="admin-grades-file" class="file-input-label w-full max-w-sm">Выбрать фото</label>
                            <input type="file" id="admin-grades-file" accept="image/*" class="hidden">
                            <div id="admin-grades-preview" class="mt-4"></div>
                        </main>
                        <footer class="flex-shrink-0 pt-4"><button id="admin-grades-s1-next" class="accent-button w-full py-4 text-lg font-semibold rounded-xl no-outline" disabled>Продолжить</button></footer>
                    `;
                    modal.innerHTML = content;
                    document.getElementById('admin-grades-file').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            state.adminFlowData.file = file;
                            const reader = new FileReader();
                            reader.onload = (ev) => { document.getElementById('admin-grades-preview').innerHTML = `<img src="${ev.target.result}" class="max-h-64 rounded-lg">`; };
                            reader.readAsDataURL(file);
                            document.getElementById('admin-grades-s1-next').disabled = false;
                        }
                    });
                    document.getElementById('admin-grades-s1-next').addEventListener('click', () => { vibrate(); renderAdminGradesStep(2); });
                    break;
                case 2: // AI Analysis
                    content = `<main class="flex-grow flex flex-col justify-center items-center text-center"><div class="loader"></div><p class="mt-4">AI анализирует оценки... 🧠</p></main>`;
                    modal.innerHTML = content;
                    processGradesPhotoForAdmin();
                    break;
                case 3: // Verification & Publish
                     content = `
                        <header class="flex-shrink-0 flex items-center justify-between pb-4"><h2 class="text-2xl font-bold">Шаг 3: Проверка</h2><button class="modal-close-btn p-2 rounded-full" style="background-color: var(--bg-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></header>
                        <main class="flex-grow overflow-y-auto">
                            <p class="mb-2">AI распознал следующие данные. Проверьте и при необходимости исправьте JSON.</p>
                            <p class="text-sm mb-2" style="color:var(--text-secondary)">Укажите номер четверти:</p>
                            <input id="admin-grades-quarter" type="number" min="1" max="4" class="admin-input mb-4" placeholder="Например, 1">
                            <textarea id="admin-grades-json-verify" rows="10" class="admin-textarea w-full text-sm">${JSON.stringify(state.adminFlowData.gradesJson, null, 2)}</textarea>
                        </main>
                        <footer class="flex-shrink-0 pt-4"><button id="admin-grades-publish" class="accent-button w-full py-4 text-lg font-semibold rounded-xl no-outline">Опубликовать</button></footer>
                    `;
                    modal.innerHTML = content;
                    document.getElementById('admin-grades-publish').addEventListener('click', publishAdminGrades);
                    break;
            }
             modal.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
        }

        async function processGradesPhotoForAdmin() {
            try {
                const imagePart = await fileToPart(state.adminFlowData.file);
                const prompt = `Проанализируй это изображение с оценками из школьного журнала. Создай JSON объект.
Структура объекта должна быть следующей:
- "subject": Название предмета, которое указано в заголовке изображения (например, "Алгебра").
- "people": Объект, где каждый ключ - это порядковый номер ученика в журнале. Значение - это объект с полями:
  - "name": Фамилия и инициал имени ученика (например, "Иванов И.").
  - "grades": Массив ВСЕХ оценок и символов для этого ученика (например, ["5","5","4","Н","Б"]).

Включи в JSON абсолютно всех учеников из списка. Если у ученика нет оценок, оставь массив "grades" пустым.
Результат должен быть одним валидным JSON объектом.`;
                const resultText = await callGemini(prompt, [imagePart]);
                state.adminFlowData.gradesJson = JSON.parse(resultText.replace(/```json/g, '').replace(/```/g, ''));
                renderAdminGradesStep(3);
            } catch (e) {
                alert(`Ошибка анализа AI: ${e.message}`);
                closeModal();
            }
        }
        
        async function publishAdminGrades() {
            vibrate();
            showLoader();
            try {
                const quarter = document.getElementById('admin-grades-quarter').value;
                if (!quarter) { alert("Укажите номер четверти!"); return; }
                const gradesData = JSON.parse(document.getElementById('admin-grades-json-verify').value);
                
                const { data: users } = await db.from('users').select('id, short_name');
                const userMap = new Map(users.map(u => [u.short_name, u.id]));

                // Clear old grades for this subject and quarter
                await db.from('grades').delete().eq('quarter', quarter).eq('subject', gradesData.subject);

                for (const studentId in gradesData.people) {
                    const student = gradesData.people[studentId];
                    const userId = userMap.get(student.name);
                    if (userId) {
                        const { error } = await db.from('grades').insert({
                            user_id: userId,
                            quarter: parseInt(quarter),
                            subject: gradesData.subject,
                            grades_data: student.grades
                        });
                        if (error) throw error;
                    }
                }
                showAdminStatus('Оценки успешно опубликованы!', false);
            } catch (err) {
                showAdminStatus(`Ошибка публикации: ${err.message}`, true);
            } finally {
                hideLoader();
                closeModal();
            }
        }


        TG.BackButton.onClick(closeModal);
        init();
    </script>
</body>
</html>

