<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KUZBOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-header: rgba(0, 0, 0, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #8B5CF6;
            --accent-light: #A78BFA;
            --border-color: #333333;
            --shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        html[data-theme='light'] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --bg-header: rgba(249, 250, 251, 0.7);
            --text-primary: #000000;
            --text-secondary: #505050;
            --accent: #7C3AED;
            --accent-light: #8B5CF6;
            --border-color: #e5e7eb;
            --shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-header {
            position: sticky; top: 0; z-index: 10;
            background-color: var(--bg-header);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding-top: calc(var(--safe-area-top) + 1rem);
            border-bottom: 1px solid var(--border-color);
        }
        .glass-nav {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
            background-color: var(--bg-header);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding-bottom: var(--safe-area-bottom);
            border-top: 1px solid var(--border-color);
        }
        main {
            padding-bottom: calc(var(--safe-area-bottom) + 70px);
        }

        .accent-button { background-color: var(--accent); color: white; box-shadow: var(--shadow); transition: all 0.2s ease-in-out; }
        .accent-button:hover:not(:disabled) { transform: scale(1.02); filter: brightness(1.1); }
        .accent-button:disabled { background-color: var(--text-secondary); opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        .no-outline:focus { outline: none; box-shadow: none; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .modal { transition: opacity 0.3s ease, transform 0.3s ease; transform: translateY(100%); opacity: 0; pointer-events: none; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .checkbox-custom { -webkit-appearance: none; appearance: none; background-color: transparent; width: 1.5rem; height: 1.5rem; border: 2px solid var(--text-secondary); border-radius: 0.375rem; display: inline-block; position: relative; cursor: pointer; transition: all 0.2s ease; }
        .checkbox-custom:checked { background-color: var(--accent); border-color: var(--accent); }
        .checkbox-custom:checked::after { content: ''; position: absolute; left: 0.45rem; top: 0.15rem; width: 0.4rem; height: 0.8rem; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
    
        .date-scroller-btn { position: relative; }
        .date-scroller-btn.active::after { content: ''; position: absolute; bottom: -8px; left: 25%; right: 25%; height: 3px; background-color: var(--accent); border-radius: 2px; }

        .screen { position: absolute; top: 0; left: 0; right: 0; height: 100%; transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .screen.left { transform: translateX(-100%); }
        .screen.right { transform: translateX(100%); }
        .screen.center { transform: translateX(0); }
        
        .admin-input, .admin-textarea {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .admin-input:focus, .admin-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .file-input-label {
            display: block;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
             background-color: var(--border-color);
        }
        #admin-status {
            position: fixed;
            bottom: calc(var(--safe-area-bottom) + 65px); /* Above nav bar */
            left: 1rem; right: 1rem; z-index: 30;
            pointer-events: none;
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="relative h-screen w-screen overflow-hidden">
        <!-- Onboarding Screen -->
        <div id="screen-onboarding" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500" style="background-color: var(--bg-primary);">
            <!-- Onboarding steps... -->
        </div>

        <!-- Main Content -->
        <div id="content-wrapper" class="opacity-0 transition-opacity duration-500 w-full h-full">
            <!-- Main App Screen -->
            <div id="screen-main" class="screen center flex-col overflow-y-auto">
                <!-- Main screen content... -->
            </div>

            <!-- Profile Screen -->
            <div id="screen-profile" class="screen right flex-col overflow-y-auto">
                 <!-- Profile screen content... -->
            </div>

            <!-- Admin Screen -->
            <div id="screen-admin" class="screen right flex-col overflow-y-auto">
                <header class="glass-header p-4 flex-shrink-0">
                    <h1 class="text-4xl font-bold tracking-tight">Админ-панель</h1>
                </header>
                <main class="flex-grow p-4 space-y-8">
                    <!-- Schedule Management -->
                    <div class="p-4 rounded-2xl" style="background-color: var(--bg-secondary);">
                        <!-- Schedule form... -->
                    </div>

                    <!-- AI Grades Assistant -->
                    <div class="p-4 rounded-2xl" style="background-color: var(--bg-secondary);">
                        <h2 class="text-2xl font-bold mb-4">AI Помощник (Оценки)</h2>
                        <p class="text-sm mb-4" style="color: var(--text-secondary);">Загрузите фото журнала, и AI создаст JSON для формы ниже.</p>
                        <div>
                            <label for="ai-grades-files" class="file-input-label">Выбрать фото журнала</label>
                            <input type="file" name="ai-grades-files" id="ai-grades-files" multiple accept="image/*" class="hidden">
                            <div id="ai-grades-preview" class="flex flex-wrap gap-2 mt-4"></div>
                        </div>
                        <button id="ai-process-btn" class="accent-button w-full py-3 text-lg font-semibold rounded-xl no-outline mt-4" disabled>Обработать</button>
                        <p id="ai-status" class="text-center mt-2 text-sm" style="color: var(--text-secondary);"></p>
                    </div>

                    <!-- Grades Management -->
                    <div class="p-4 rounded-2xl" style="background-color: var(--bg-secondary);">
                        <h2 class="text-2xl font-bold mb-4">Управление оценками (JSON)</h2>
                        <form id="grades-form" class="space-y-4">
                             <p class="text-sm" style="color: var(--text-secondary);">Вставьте JSON для массового обновления оценок.</p>
                             <div><label class="font-medium mb-1 block">Четверть</label><input type="number" name="admin-grades-quarter" min="1" max="4" required class="admin-input" placeholder="1"></div>
                             <div><label class="font-medium mb-1 block">JSON с оценками</label><textarea id="admin-grades-json" name="admin-grades-json" rows="6" class="admin-textarea" placeholder='[{"full_name": "Иванов Иван", "subject": "Математика", "all": ["5","4","Н"], "avg": "4.5"}]'></textarea></div>
                             <button type="submit" class="accent-button w-full py-3 text-lg font-semibold rounded-xl no-outline mt-4">Обновить оценки</button>
                        </form>
                    </div>
                </main>
            </div>
            
            <nav id="app-nav" class="glass-nav flex justify-around items-center h-[55px]"></nav>
        </div>

        <div id="admin-status" class="text-center p-4 rounded-lg opacity-0 transition-opacity duration-300"></div>

        <!-- Modals -->
        <div id="modal-overlay" class="modal-overlay fixed inset-0 z-20"></div>
        <!-- Other modals... -->
    </div>

    <script>
        const SUPABASE_URL = 'https://biooiajgiryjxkeqtakg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb29pYWpnaXJ5anhrZXF0YWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4Njk2NDMsImV4cCI6MjA3NTQ0NTY0M30._DmT77M0LcRLHQDRdKZmspOsxuXIByGuiBDndfIMK1Y';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const TG = window.Telegram.WebApp;

        // --- DOM ELEMENTS & STATE ---
        // (Same as before)
        
        let state = { user: null, currentScreen: 'main', screens: ['main', 'profile'] };
        let currentOpenModal = null; let currentLessonCache = null;

        // --- ONBOARDING & APP INIT ---
        // (Same as before, no changes needed here)

        function startApp() { 
            if (state.user.is_admin) state.screens.push('admin'); 
            document.getElementById('content-wrapper').classList.add('opacity-100'); 
            renderNav(); 
            setupDateScroller(); 
            renderHomeworkForDate(new Date()); 
            renderProfile(); 
            if(state.user.is_admin) setupAdminPanel(); 
        }
        
        // --- NAVIGATION, HOMEWORK, PROFILE ---
        // (Same as before, no changes needed here)

        // --- ADMIN PANEL LOGIC ---
        function setupAdminPanel() {
            document.getElementById('schedule-form').addEventListener('submit', handleScheduleSubmit);
            document.getElementById('grades-form').addEventListener('submit', handleGradesSubmit);
            
            const hwFileInput = document.getElementById('admin-hw-files');
            const answerFileInput = document.getElementById('admin-answer-files');
            
            hwFileInput.addEventListener('change', () => updateFileList('hw-files-list', hwFileInput.files));
            answerFileInput.addEventListener('change', () => updateFileList('answer-files-list', answerFileInput.files));

            // AI Assistant Setup
            const aiFileInput = document.getElementById('ai-grades-files');
            const aiProcessBtn = document.getElementById('ai-process-btn');
            aiFileInput.addEventListener('change', handleAiFileSelect);
            aiProcessBtn.addEventListener('click', processGradesWithAI);
        }

        function showAdminStatus(message, isError) { 
            const statusEl = document.getElementById('admin-status'); 
            statusEl.textContent = message; 
            statusEl.className = `text-center p-4 rounded-lg opacity-100 transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`; 
            setTimeout(() => { statusEl.classList.remove('opacity-100'); }, 4000); 
        }

        // --- AI ASSISTANT FUNCTIONS ---
        function handleAiFileSelect(event) {
            const files = event.target.files;
            const preview = document.getElementById('ai-grades-preview');
            const processBtn = document.getElementById('ai-process-btn');
            preview.innerHTML = '';
            if (files.length > 0) {
                for(const file of files) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-20 h-20 object-cover rounded-lg';
                        preview.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
                processBtn.disabled = false;
            } else {
                processBtn.disabled = true;
            }
        }

        async function processGradesWithAI() {
            const files = document.getElementById('ai-grades-files').files;
            if (files.length === 0) return;

            const processBtn = document.getElementById('ai-process-btn');
            const aiStatus = document.getElementById('ai-status');
            processBtn.disabled = true;
            aiStatus.textContent = 'Анализирую фото... 🧠';

            const apiKey = "AIzaSyCglJfoIkzBHeJ3uq4b6afqYs3g6niKgd0"; // Will be replaced by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const fileToPart = file => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({
                    inlineData: { mimeType: file.type, data: reader.result.split(',')[1] }
                });
                reader.readAsDataURL(file);
            });

            const imageParts = await Promise.all(Array.from(files).map(fileToPart));
            
            const prompt = `Проанализируй эти изображения с оценками. Для каждого предмета (например, "История", "Литература", "Химия" и т.д.) создай JSON объект. ВАЖНО: Включи в JSON только учеников, у которых есть хотя бы одна оценка.
Структура объекта должна быть следующей:
- "full_name": Полное имя и фамилия ученика (например, "Азаренко К. А.").
- "subject": Название предмета, которое указано в заголовке изображения.
- "all": Массив ВСЕХ оценок и символов (например, ["5", "5", "Н", "Б"]).
- "avg": Средний балл, указанный в столбце "Ср. балл".

Собери все эти объекты в один JSON массив. Убедись, что результат - это валидный JSON.

Пример: [{"full_name": "Азаренко К. А.", "subject": "История", "all": ["5","5"], "avg": "5.00"}]`;


            const payload = {
                contents: [{ parts: [{ text: prompt }, ...imageParts] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    document.getElementById('admin-grades-json').value = JSON.stringify(JSON.parse(text), null, 2);
                    aiStatus.textContent = '✅ Готово! JSON вставлен в форму ниже.';
                } else {
                    throw new Error("Не удалось получить JSON от AI.");
                }
            } catch (error) {
                console.error("AI processing error:", error);
                aiStatus.textContent = `❌ Ошибка: ${error.message}`;
            } finally {
                processBtn.disabled = false;
            }
        }
        
        // --- EXISTING ADMIN & MODAL FUNCTIONS ---
        // (Same as before, no changes needed here)

        TG.BackButton.onClick(closeModal);
        init();
    </script>
</body>
</html>

