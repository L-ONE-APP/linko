<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GigaChat Тестовый Чат</title>
    <!-- Подключение Tailwind CSS для стилей -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Конфигурация шрифтов Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-4">

    <!-- Основной контейнер чата -->
    <div id="chat-container" class="bg-white rounded-xl shadow-2xl flex flex-col w-full max-w-xl h-[90vh] md:h-[80vh]">

        <!-- Заголовок -->
        <header class="p-4 bg-green-600 text-white rounded-t-xl shadow-lg flex items-center justify-between">
            <h1 class="text-2xl font-bold">GigaChat Тест</h1>
            <span id="status-indicator" class="text-sm font-medium opacity-70">
                Подключение...
            </span>
        </header>

        <!-- Область сообщений -->
        <div id="messages-area" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
            <!-- Сообщения будут добавлены сюда -->
            <div class="flex justify-start">
                <div class="bg-gray-200 text-gray-800 p-3 rounded-xl rounded-bl-sm shadow-md max-w-[80%]">
                    <p class="font-semibold">GigaChat:</p>
                    <p>Добро пожаловать в GigaChat. Начните общение, чтобы получить токен доступа.</p>
                </div>
            </div>
        </div>

        <!-- Область ввода -->
        <div class="p-4 border-t border-gray-200 flex items-center space-x-3">
            <input type="text" id="user-input" placeholder="Введите ваше сообщение..."
                   class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150"
                   onkeydown="if(event.key === 'Enter') document.getElementById('send-button').click()">

            <button id="send-button"
                    class="bg-green-600 text-white p-3 rounded-xl shadow-lg hover:bg-green-700 transition duration-150 disabled:bg-gray-400 disabled:shadow-none"
                    onclick="handleSend()">
                <svg id="send-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
                <svg id="loading-spinner" class="w-6 h-6 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

    </div>

    <script>
        // =======================================================
        // --- КОНФИГУРАЦИЯ БЕЗОПАСНОСТИ (ОЧЕНЬ ВАЖНО) ---
        // Хранение ключей в этом файле небезопасно и используется ТОЛЬКО
        // для демонстрационных или личных тестовых целей, как вы и просили.
        // =======================================================

        const AUTHORIZATION_KEY = "MDE5OWRkN2ItY2QyNC03Mjg2LWI4ZGUtZGMyNmUzYWE5NThiOjYzZTFmOTgzLWRmNmMtNGVkOS1hMDU4LWExNjk4ZGY3NGZiMQ==";
        const OAUTH_URL = 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth';
        const CHAT_URL = 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions';
        const MODEL = 'GigaChat-Pro';
        const SCOPE = 'GIGACHAT_API_PERS';
        const MAX_RETRIES = 3;

        // =======================================================
        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ ---
        // =======================================================

        let accessToken = null;
        let tokenExpiry = 0; // Время истечения токена в миллисекундах
        let isSending = false;
        let chatHistory = [
            { role: "system", content: "Ты — полезный, дружелюбный и креативный помощник GigaChat." }
        ];

        // =======================================================
        // --- Вспомогательные функции UI ---
        // =======================================================

        const messagesArea = document.getElementById('messages-area');
        const inputField = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusIndicator = document.getElementById('status-indicator');

        function setSending(state) {
            isSending = state;
            sendButton.disabled = state;
            inputField.disabled = state;
            if (state) {
                sendIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                statusIndicator.textContent = "Отправка...";
            } else {
                sendIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                statusIndicator.textContent = accessToken ? "Подключено" : "Ошибка токена";
            }
        }

        function renderMessages() {
            // Очищаем область сообщений, исключая системное сообщение
            messagesArea.innerHTML = '';

            // Отображаем только сообщения пользователя и ассистента
            const displayMessages = chatHistory.filter(msg => msg.role !== 'system');

            displayMessages.forEach(msg => {
                const isUser = msg.role === 'user';
                const messageHtml = `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="p-3 rounded-xl shadow-md max-w-[80%] ${
                            isUser
                                ? 'bg-green-500 text-white rounded-br-sm'
                                : 'bg-gray-200 text-gray-800 rounded-bl-sm'
                        }">
                            <p class="font-semibold ${isUser ? 'hidden' : 'block'}">GigaChat:</p>
                            <p>${msg.content.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
                messagesArea.insertAdjacentHTML('beforeend', messageHtml);
            });

            // Прокрутка вниз
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function displayError(message) {
            const errorHtml = `
                <div class="flex justify-start">
                    <div class="bg-red-200 text-red-800 p-3 rounded-xl rounded-bl-sm shadow-md max-w-[80%]">
                        <p class="font-semibold">Ошибка:</p>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            messagesArea.insertAdjacentHTML('beforeend', errorHtml);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            statusIndicator.textContent = "Ошибка: См. консоль";
        }

        // =======================================================
        // --- СЕТЕВЫЕ ФУНКЦИИ ---
        // =======================================================

        async function backoffFetch(url, options, maxRetries = MAX_RETRIES) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // Если ошибка 4xx/5xx, пробуем еще раз (кроме 401/403, которые могут указывать на проблему с токеном)
                    if (response.status >= 400 && response.status !== 401 && response.status !== 403) {
                        const errorData = await response.text();
                        console.error(`Fetch attempt ${i + 1} failed with status ${response.status}: ${errorData}`);
                    } else {
                         // Для 401/403 или других невосстановимых ошибок выходим
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${2 ** i}s...`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (2 ** i)));
                }
            }
            throw new Error("Maximum retries reached.");
        }

        async function getAccessToken() {
            // Проверяем, не истек ли токен (с запасом 60 секунд)
            if (accessToken && Date.now() < tokenExpiry - 60000) {
                return accessToken;
            }

            statusIndicator.textContent = "Обновление токена...";

            const body = new URLSearchParams({ scope: SCOPE }).toString();
            const headers = {
                'Authorization': 'Basic ' + AUTHORIZATION_KEY,
                'Content-Type': 'application/x-www-form-urlencoded',
                // RqUID должен быть уникальным для каждого запроса токена
                'RqUID': crypto.randomUUID(),
                'Accept': 'application/json'
            };

            try {
                const response = await backoffFetch(OAUTH_URL, {
                    method: 'POST',
                    headers: headers,
                    body: body,
                });

                const data = await response.json();

                if (data.access_token) {
                    accessToken = data.access_token;
                    // Время жизни токена в секундах, переводим в мс и добавляем к текущему времени
                    tokenExpiry = Date.now() + (data.expires_at || 3600) * 1000;
                    statusIndicator.textContent = "Подключено";
                    return accessToken;
                } else {
                    throw new Error("Token not found in response.");
                }

            } catch (error) {
                console.error("Ошибка при получении токена GigaChat:", error);
                displayError("Не удалось получить токен GigaChat. Проверьте ключ и консоль.");
                accessToken = null;
                tokenExpiry = 0;
                setSending(false); // Отключаем, если была ошибка
                return null;
            }
        }

        async function sendMessage(prompt) {
            const token = await getAccessToken();
            if (!token) return;

            // Добавляем сообщение пользователя в историю перед отправкой
            chatHistory.push({ role: "user", content: prompt });

            const payload = {
                model: MODEL,
                messages: chatHistory,
                temperature: 0.7,
            };

            const headers = {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            try {
                const response = await backoffFetch(CHAT_URL, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                
                if (data.choices && data.choices.length > 0) {
                    const assistantMessage = data.choices[0].message;
                    chatHistory.push(assistantMessage);
                } else {
                    throw new Error("Не получен ответ от GigaChat.");
                }

            } catch (error) {
                console.error("Ошибка при отправке сообщения GigaChat:", error);
                displayError(`Ошибка GigaChat: ${error.message}. Пожалуйста, попробуйте еще раз.`);
                
                // Удаляем последнее сообщение пользователя, чтобы он мог повторить запрос
                chatHistory.pop(); 
            }
        }

        // =======================================================
        // --- ОСНОВНОЙ ОБРАБОТЧИК ---
        // =======================================================

        async function handleSend() {
            if (isSending) return;

            const input = inputField.value.trim();
            if (input === '') return;

            inputField.value = ''; // Очистка поля ввода
            setSending(true);
            renderMessages(); // Отобразить сообщение пользователя

            await sendMessage(input);

            setSending(false);
            renderMessages(); // Отобразить ответ GigaChat
        }

        // Первоначальная отрисовка
        document.addEventListener('DOMContentLoaded', () => {
             renderMessages();
             // Устанавливаем статус "Ожидание ввода" до первого запроса токена
             statusIndicator.textContent = "Ожидание ввода...";
        });

    </script>
</body>
</html>
